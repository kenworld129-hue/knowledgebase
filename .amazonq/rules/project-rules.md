# システム障害管理ツール - 開発ルール

## プロジェクト情報
- **プロジェクト名**: システム障害管理ツール (Knowledge Base)
- **プロジェクトパス**: `/Users/kenshun/red/knowledgebase`
- **フロントエンド**: Next.js + TypeScript
- **バックエンド**: Rust (Axum)
- **データベース**: PostgreSQL
- **認証**: JWT

## コーディング規約

### Rust (バックエンド)

#### 状態管理
- 全てのハンドラーで`State<AppState>`を使用
- `AppState`構造体には`pool: PgPool`と`secret: String`を含める
- `State<PgPool>`を直接使用しない

#### ハンドラー実装
- ハンドラーは`handlers/`ディレクトリに配置
- 非同期関数として実装 (`async fn`)
- エラーハンドリングは`StatusCode`で返却

#### ルーティング
- ルート定義は`routes/`ディレクトリに配置
- `AppState`を`with_state()`で渡す
- 認証が必要なエンドポイントには`require_jwt`ミドルウェアを適用

#### データモデル
- `models/`ディレクトリに配置
- `serde`の`Serialize`/`Deserialize`を実装
- SQLxの`FromRow`を使用

#### 環境変数
- `.env`ファイルで管理
- 必須変数: `DATABASE_URL`, `JWT_SECRET`
- `dotenvy`で読み込み

### TypeScript (フロントエンド)

#### ディレクトリ構造
- Pages Routerを使用 (`pages/`ディレクトリ)
- API通信は`lib/api.ts`に集約
- 共通コンポーネントは`components/`に配置（必要に応じて作成）

#### API通信
- JWTトークンは`Authorization: Bearer <token>`ヘッダーで送信
- エラーハンドリングを適切に実装

## 認証ルール

### JWT
- ログイン成功時にJWTトークンを発行
- トークンにはユーザー情報を含める
- 有効期限を設定（推奨: 24時間）

### パスワード
- bcryptでハッシュ化
- 平文パスワードは保存しない

### 保護されたエンドポイント
- `/auth/*` 配下は認証ミドルウェアで保護
- 認証失敗時は`401 Unauthorized`を返却

## データベースルール

### マイグレーション
- SQLxのマイグレーション機能を使用
- マイグレーションファイルは`migrations/`に配置

### クエリ
- `sqlx::query_as!`マクロを使用（型安全性）
- プリペアドステートメントでSQLインジェクション対策

## エラーハンドリング

### バックエンド
- `StatusCode`でHTTPステータスを返却
- エラー詳細は`Json`でレスポンス
- ログ出力は`tracing`を使用

### フロントエンド
- APIエラーは適切にキャッチ
- ユーザーにわかりやすいエラーメッセージを表示

## セキュリティルール

1. **環境変数**: 本番環境では強力な`JWT_SECRET`を使用
2. **CORS**: 本番環境では適切なオリジンを設定
3. **パスワード**: 最小8文字、複雑性要件を推奨
4. **トークン**: ローカルストレージではなくhttpOnlyクッキー推奨（将来的に）

## コミットルール

### コミットメッセージ
- プレフィックスを使用:
  - `feat:` 新機能
  - `fix:` バグ修正
  - `refactor:` リファクタリング
  - `docs:` ドキュメント
  - `test:` テスト追加

### ブランチ戦略
- `main`: 本番環境
- `develop`: 開発環境
- `feature/*`: 機能開発

## テストルール

### バックエンド
- 単体テストは`#[cfg(test)]`モジュールで実装
- 統合テストは`tests/`ディレクトリに配置

### フロントエンド
- コンポーネントテストを実装（Jest/React Testing Library推奨）

## パフォーマンスルール

1. **ページネーション**: 一覧取得は必ずページネーション実装
2. **インデックス**: 頻繁に検索するカラムにはインデックスを作成
3. **接続プール**: DB接続はプールを使用

## 開発フロー

1. 機能要件を明確化
2. データモデル設計
3. バックエンドAPI実装
4. フロントエンド実装
5. 統合テスト
6. デプロイ

## 禁止事項

- ❌ 平文パスワードの保存
- ❌ SQLインジェクション脆弱性のあるクエリ
- ❌ 認証なしでの機密情報アクセス
- ❌ ハードコードされた認証情報
- ❌ 不要なデータの過剰取得